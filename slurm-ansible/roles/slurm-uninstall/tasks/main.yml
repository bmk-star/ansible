---
### STOP SERVICES #############################################################
- name: Stop Slurm & MariaDB services
  service:
    name: "{{ item }}"
    state: stopped
    enabled: no
  loop:
    - slurmctld
    - slurmd
    - slurmdbd
    - mariadb
    - mysql
    - munge
  ignore_errors: yes

###############################################################################
### REMOVE PACKAGES (APT – Ubuntu 24.04) ######################################
###############################################################################
- name: Remove Slurm packages (apt)
  apt:
    name:
      - slurm-wlm
      - slurmctld
      - slurmd
      - slurmdbd
      - slurm-client
      - libslurm*      
      - munge
      - libmunge-dev
      - libmunge2
    state: absent
    purge: yes
    autoremove: yes
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Remove MariaDB/MySQL packages (apt)
  apt:
    name:
      - mariadb-server
      - mariadb-client
      - mariadb-common
      - mysql-common
      - mysql-server
      - mysql-client
      - python3-pymysql
    state: absent
    purge: yes
    autoremove: yes
  when: ansible_os_family == "Debian"
  ignore_errors: yes

###############################################################################
### REMOVE DATA DIRECTORIES ###################################################
###############################################################################
- name: Remove Slurm directories
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/slurm
    - /var/spool/slurmctld
    - /var/spool/slurmd
    - /var/log/slurm
    - /run/slurm

- name: Remove Munge directories
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/munge
    - /var/log/munge
    - /var/run/munge

- name: Remove MariaDB directories (DATA LOSS — OK for uninstall)
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/mysql
    - /etc/mysql
    - /var/log/mysql
    - /var/run/mysqld
    - /var/lib/mysql-files
    - /var/lib/mysql-keyring
    - /etc/mysql/mariadb.conf.d
  ignore_errors: yes

###############################################################################
### SYSTEMD CLEANUP ###########################################################
###############################################################################
- name: Remove systemd override folders
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/systemd/system/slurmctld.service.d
    - /etc/systemd/system/slurmd.service.d
    - /etc/systemd/system/slurmdbd.service.d
    - /etc/systemd/system/mariadb.service.d

# Reload systemd after cleanup
- name: Reload systemd
  systemd:
    daemon_reload: yes
